name: CI/CD GKE Cluster

on:
  push:
    branches:
      - staging
      - main

jobs:
  staging:
    name: Deploy to Staging GKE
    if: ${{ github.ref == 'refs/heads/staging' }}
    uses: chandan-cloudops/E-commerce-EKS-Terraform/.github/workflows/_deployment.yaml@staging
    with:
      environment: staging
      env_id: stg
      ref: ${{ github.sha }}
      folder: staging_deployments_files
      branch: staging                     # ✅ added
      base_files: "celery-worker celerybeat flower solaace"   # ✅ added
    secrets:
      GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
      GIT_PASSWORD: ${{ secrets.GIT_PASSWORD }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  production:
    name: Deploy to Production GKE
    if: ${{ github.ref == 'refs/heads/main' }}
    uses: chandan-cloudops/E-commerce-EKS-Terraform/.github/workflows/_deployment.yaml@releasing
    with:
      environment: production
      env_id: prod
      ref: ${{ github.sha }}
      folder: production_deployment_files
      branch: releasing                    # ✅ added
      base_files: "celery-worker celerybeat flower solaace"  # ✅ added
    secrets:
      GIT_USERNAME: ${{ secrets.GIT_USERNAME }}
      GIT_PASSWORD: ${{ secrets.GIT_PASSWORD }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
